{% extends "base.html" %}

{% block title %}Admin Dashboard - Survey Kiosk{% endblock %}

{% block content %}
<div class="header">
    <h1>Admin Dashboard</h1>
    <a href="/admin/logout" class="btn btn-secondary">Logout</a>
</div>

<div style="margin-bottom: 30px;">
    <a href="/admin/survey/new" class="btn">Create New Survey</a>
</div>

<h2>All Surveys</h2>

{% if surveys %}
<ul class="survey-list">
    {% for survey in surveys %}
    <li class="survey-item">
        <h3>{{ survey.get('title_en', survey.get('title', 'Untitled')) }} / {{ survey.get('title_sv', survey.get('title', 'Utan titel')) }}</h3>
        <p>{{ survey.get('description_en', survey.get('description', ''))[:100] }}...</p>
        <div style="font-size: 14px; color: var(--text-light); margin-top: 10px;">
            <p><strong>Created:</strong> {{ survey.created_at[:16].replace('T', ' ') if survey.created_at else 'N/A' }}</p>
            <p><strong>First Response:</strong> {{ survey.first_response_at[:16].replace('T', ' ') if survey.first_response_at else 'No responses yet' }}</p>
            <p><strong>Items:</strong> {{ survey['items']|length }}</p>
        </div>
        <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
            <a href="/admin/survey/{{ survey.id }}/results" class="btn">View Results</a>
            <a href="/admin/survey/{{ survey.id }}/edit" class="btn btn-secondary">Edit Survey</a>
            <button onclick="duplicateSurvey('{{ survey.id }}', '{{ survey.get('title_en', '') }}', '{{ survey.get('title_sv', '') }}')" class="btn btn-accent">Duplicate</button>
            <button onclick="resetSurvey('{{ survey.id }}')" class="btn btn-warning">Reset Ratings</button>
            <button onclick="deleteSurvey('{{ survey.id }}')" class="btn btn-danger">Delete</button>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<div style="text-align: center; padding: 40px;">
    <p style="color: var(--text-light); font-size: 18px;">No surveys created yet.</p>
    <p style="color: var(--text-light); margin-top: 10px;">Click "Create New Survey" to get started.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function deleteSurvey(surveyId) {
    if (!confirm('Are you sure you want to delete this survey? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/admin/survey/${surveyId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            alert('Survey deleted successfully');
            window.location.reload();
        } else {
            alert('Error deleting survey');
        }
    } catch (error) {
        alert('Error deleting survey');
    }
}

async function duplicateSurvey(surveyId, titleEn, titleSv) {
    const newTitleEn = prompt('Enter new survey title (English):', titleEn + ' (Copy)');
    if (!newTitleEn) return;

    const newTitleSv = prompt('Enter new survey title (Swedish):', titleSv + ' (Kopia)');
    if (!newTitleSv) return;

    try {
        const response = await fetch(`/admin/survey/${surveyId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                new_title_en: newTitleEn,
                new_title_sv: newTitleSv
            })
        });

        if (response.ok) {
            alert('Survey duplicated successfully');
            window.location.reload();
        } else {
            alert('Error duplicating survey');
        }
    } catch (error) {
        alert('Error duplicating survey');
    }
}

async function resetSurvey(surveyId) {
    if (!confirm('Are you sure you want to reset all ratings for this survey? This will delete all responses and cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/admin/survey/${surveyId}/reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            alert('Survey ratings reset successfully');
            window.location.reload();
        } else {
            alert('Error resetting survey ratings');
        }
    } catch (error) {
        alert('Error resetting survey ratings');
    }
}
</script>
{% endblock %}
